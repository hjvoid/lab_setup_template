name: Lab CI

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  compose-build-and-smoke-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show versions
        run: |
          docker --version
          docker compose version

      - name: Validate compose file
        run: docker compose config

      - name: Build + start lab
        run: docker compose up -d --build

      - name: Smoke tests
        run: |
          docker compose exec -T attacker sh -lc 'getent hosts dvwa'

          # Wait for DVWA to respond over HTTP (up to ~60 seconds)
          for i in $(seq 1 30); do
            if docker compose exec -T attacker sh -lc 'curl -fsS -I http://dvwa >/dev/null'; then
              echo "DVWA is up"
              break
            fi
            echo "Waiting for DVWA... ($i/30)"
            sleep 2
          done

          docker compose exec -T attacker sh -lc 'curl -sS -I http://dvwa | head -n 1'
          docker compose exec -T attacker sh -lc '/opt/lab-venv/bin/python -c "import scapy.all, impacket, pwn, boofuzz, mitmproxy; print(\"python-ok\")"'

      - name: Show running containers
        run: docker compose ps

      - name: Teardown
        if: always()
        run: docker compose down -v
